<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Asistencia - Estudiante</title>
  <link rel="stylesheet" href="/shared/styles/base.css">
  <link rel="stylesheet" href="./styles/guest.css">
</head>
<body>
  <div class="guest-app">
    <!-- Header -->
    <header class="guest-header">
      <h1>Sistema de Asistencia</h1>
      <div id="user-info" class="user-info hidden">
        <span id="user-name"></span>
      </div>
    </header>

    <!-- Main Content - cambia según el estado -->
    <main class="guest-main">
      
      <!-- Estado: Inicializando -->
      <section id="state-init" class="state-view active">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Conectando...</p>
        </div>
      </section>

      <!-- Estado: Verificando Enrollment -->
      <section id="state-checking-enrollment" class="state-view">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Verificando dispositivo...</p>
        </div>
      </section>

      <!-- Estado: No Enrolado -->
      <section id="state-no-enrolled" class="state-view">
        <div class="enrollment-prompt">
          <div class="icon-container">
            <svg class="icon-fingerprint" viewBox="0 0 24 24" width="80" height="80">
              <path fill="currentColor" d="M17.81,4.47C17.73,4.47 17.65,4.45 17.58,4.41C15.66,3.42 14,3 12,3C10.03,3 8.15,3.47 6.44,4.41C6.2,4.54 5.9,4.45 5.76,4.21C5.63,3.97 5.72,3.66 5.96,3.53C7.82,2.5 9.86,2 12,2C14.14,2 16,2.47 18.04,3.5C18.29,3.65 18.38,3.95 18.25,4.19C18.16,4.37 18,4.47 17.81,4.47M3.5,9.72C3.4,9.72 3.3,9.69 3.21,9.63C3,9.47 2.93,9.16 3.09,8.93C4.08,7.53 5.34,6.43 6.84,5.66C10,4.04 14,4.03 17.15,5.65C18.65,6.42 19.91,7.5 20.9,8.9C21.06,9.12 21,9.44 20.78,9.6C20.55,9.76 20.24,9.71 20.08,9.5C19.18,8.22 18.04,7.23 16.69,6.54C13.82,5.07 10.15,5.07 7.29,6.55C5.93,7.25 4.79,8.25 3.89,9.5C3.81,9.65 3.66,9.72 3.5,9.72M9.75,21.79C9.62,21.79 9.5,21.74 9.4,21.64C8.53,20.77 8.06,20.21 7.39,19C6.7,17.77 6.34,16.27 6.34,14.66C6.34,11.69 8.88,9.27 12,9.27C15.12,9.27 17.66,11.69 17.66,14.66A0.5,0.5 0 0,1 17.16,15.16A0.5,0.5 0 0,1 16.66,14.66C16.66,12.24 14.57,10.27 12,10.27C9.43,10.27 7.34,12.24 7.34,14.66C7.34,16.1 7.66,17.43 8.27,18.5C8.91,19.66 9.35,20.15 10.12,20.93C10.31,21.13 10.31,21.44 10.12,21.64C10,21.74 9.88,21.79 9.75,21.79M16.92,19.94C15.73,19.94 14.68,19.64 13.82,19.05C12.33,18.04 11.44,16.4 11.44,14.66A0.5,0.5 0 0,1 11.94,14.16A0.5,0.5 0 0,1 12.44,14.66C12.44,16.07 13.16,17.4 14.38,18.22C15.09,18.7 15.92,18.93 16.92,18.93C17.16,18.93 17.56,18.9 17.96,18.83C18.23,18.78 18.5,18.96 18.54,19.24C18.59,19.5 18.41,19.77 18.13,19.82C17.56,19.93 17.06,19.94 16.92,19.94M14.91,22C14.87,22 14.82,22 14.78,22C13.19,21.54 12.15,20.95 11.06,19.88C9.66,18.5 8.89,16.64 8.89,14.66C8.89,12.91 10.3,11.5 12.05,11.5C13.8,11.5 15.21,12.91 15.21,14.66C15.21,15.73 16.07,16.59 17.13,16.59C18.19,16.59 19.05,15.73 19.05,14.66C19.05,10.89 15.96,7.83 12.14,7.83C8.32,7.83 5.23,10.89 5.23,14.66C5.23,15.96 5.5,17.18 6.03,18.25C6.15,18.5 6.05,18.8 5.79,18.92C5.54,19.04 5.24,18.94 5.12,18.68C4.5,17.45 4.23,16.1 4.23,14.66C4.23,10.33 7.79,6.83 12.14,6.83C16.5,6.83 20.05,10.33 20.05,14.66C20.05,16.28 18.75,17.59 17.13,17.59C15.5,17.59 14.21,16.28 14.21,14.66C14.21,13.46 13.25,12.5 12.05,12.5C10.85,12.5 9.89,13.46 9.89,14.66C9.89,16.36 10.55,17.96 11.76,19.16C12.71,20.1 13.62,20.62 15.03,21C15.3,21.08 15.45,21.36 15.38,21.62C15.33,21.85 15.12,22 14.91,22Z"/>
            </svg>
          </div>
          <h2>Dispositivo no registrado</h2>
          <p>Para marcar asistencia, primero debes registrar este dispositivo usando tu huella digital o método biométrico.</p>
          <button id="btn-start-enrollment" class="btn primary large">
            Registrar Dispositivo
          </button>
          <p class="hint">Solo necesitas hacerlo una vez</p>
        </div>
      </section>

      <!-- Estado: Enrolando -->
      <section id="state-enrolling" class="state-view">
        <div class="enrolling-container">
          <div class="spinner large"></div>
          <h2>Registrando dispositivo...</h2>
          <p id="enrolling-message">Sigue las instrucciones de tu dispositivo</p>
        </div>
      </section>

      <!-- Estado: Enrollment Exitoso -->
      <section id="state-enrollment-success" class="state-view">
        <div class="success-container">
          <div class="icon-container success large">
            <svg class="icon-check" viewBox="0 0 24 24" width="80" height="80">
              <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
            </svg>
          </div>
          <h2 id="enrollment-success-message">¡Dispositivo registrado!</h2>
          <p id="penalty-info" class="penalty-info hidden">
            Por seguridad, debes esperar antes de poder marcar asistencia.
          </p>
          <button id="btn-close-return" class="btn primary large">
            Cerrar y Volver
          </button>
        </div>
      </section>

      <!-- Estado: Esperando Penalizacion -->
      <section id="state-penalty-wait" class="state-view">
        <div class="penalty-container">
          <div class="icon-container warning">
            <svg class="icon-clock" viewBox="0 0 24 24" width="60" height="60">
              <path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/>
            </svg>
          </div>
          <h2>Debes esperar</h2>
          <p>Por seguridad, debes esperar <strong id="penalty-minutes">0</strong> minutos antes de poder registrar otro dispositivo.</p>
          <button id="btn-close-return-penalty" class="btn secondary" onclick="window.parent.postMessage({type:'REQUEST_CLOSE'}, '*')">
            Cerrar y Volver
          </button>
        </div>
      </section>

      <!-- Estado: Iniciando Sesion ECDH -->
      <section id="state-logging-in" class="state-view">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Iniciando sesión segura...</p>
        </div>
      </section>

      <!-- Estado: Listo para escanear (antes ENROLLED) -->
      <section id="state-ready-to-scan" class="state-view">
        <div class="enrolled-container">
          <div class="icon-container success">
            <svg class="icon-check" viewBox="0 0 24 24" width="60" height="60">
              <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
            </svg>
          </div>
          <h2>Dispositivo listo</h2>
          <p>Puedes escanear el código QR cuando el profesor lo muestre</p>
          <button id="btn-start-scanner" class="btn primary large">
            Iniciar Escáner
          </button>
          <div id="device-info" class="device-info">
            <small>Dispositivos registrados: <span id="device-count">1</span>/5</small>
          </div>
        </div>
      </section>

      <!-- Estado: Escaneando -->
      <section id="state-scanning" class="state-view">
        <div class="scanner-container">
          <div class="scanner-video-wrapper">
            <video id="scanner-video" autoplay muted playsinline></video>
            <div class="scanner-overlay">
              <div class="scanner-frame"></div>
            </div>
          </div>
          <div id="scan-status" class="scan-status">
            Apunta al código QR
          </div>
          <button id="btn-stop-scanner" class="btn secondary">
            Cancelar
          </button>
        </div>
      </section>

      <!-- Estado: Validando QR -->
      <section id="state-validating" class="state-view">
        <div class="validating-container">
          <div class="spinner"></div>
          <p>Verificando código QR...</p>
        </div>
      </section>

      <!-- Estado: Completado -->
      <section id="state-completed" class="state-view">
        <div class="completed-container">
          <div class="icon-container success large">
            <svg class="icon-check" viewBox="0 0 24 24" width="80" height="80">
              <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
            </svg>
          </div>
          <h2>¡Asistencia Registrada!</h2>
          <p id="attendance-result">Tu asistencia ha sido registrada correctamente.</p>
        </div>
      </section>

      <!-- Estado: Error -->
      <section id="state-error" class="state-view">
        <div class="error-container">
          <div class="icon-container error">
            <svg class="icon-error" viewBox="0 0 24 24" width="60" height="60">
              <path fill="currentColor" d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
            </svg>
          </div>
          <h2>Error</h2>
          <p id="error-message">Ha ocurrido un error.</p>
          <button id="btn-retry" class="btn primary">
            Reintentar
          </button>
        </div>
      </section>

    </main>

    <!-- Footer -->
    <footer class="guest-footer">
      <small>Sistema de Asistencia UCN v1.0</small>
    </footer>
  </div>

  <script type="module" src="./main.ts"></script>
</body>
</html>
