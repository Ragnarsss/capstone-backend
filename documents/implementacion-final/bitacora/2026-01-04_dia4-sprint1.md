# Bitácora Día 4 - Sprint 1

## Sistema de Asistencia con Reconocimiento Biométrico

**Fecha:** 2026-01-04  
**Sprint:** Sprint 1 - Tests E2E y Documentación  
**Horas trabajadas:** 0 horas (inicio programado)  
**Estado general:** EN PROGRESO

---

## Objetivos del Día

- Setup Playwright en backend/tests/e2e/ - PENDIENTE
- Test flujo profesor: main_curso.php → JWT → qr-host - PENDIENTE
- Test flujo estudiante: horario.php → JWT → qr-reader - PENDIENTE
- Test validación TOTP y registro en BD - PENDIENTE
- CI integration GitHub Actions (job test-e2e) - PENDIENTE
- Healthcheck contenedor backend (/healthz) - PENDIENTE
- Documentación API OpenAPI 3.0 - PENDIENTE
- Plan disk space monitoring - PENDIENTE

---

## Resumen Ejecutivo

**Objetivo crítico:** Implementar tests E2E automatizados con Playwright para validar flujos completos profesor/estudiante y preparar validación de requisitos funcionales.

**Prerequisitos completados (Día 3):**

- Backend staging funcional en localhost:3000
- PostgreSQL en puerto 15432
- Valkey en puerto 16379
- Apache proxy configurado (/api, /ws)
- JWT endpoint operacional

**Entregables esperados:**

- Tests E2E profesor/estudiante ejecutándose localmente
- CI/CD job test-e2e en GitHub Actions
- Endpoint /healthz funcional
- Spec OpenAPI documentada
- Script monitoreo disk space

---

## Actividades Realizadas

### Fase 1: Setup Playwright (estimado 1-2h)

**Objetivo:** Configurar Playwright en proyecto backend para tests E2E browser automation.

**Tareas:**

1. Instalar dependencias Playwright

   ```bash
   cd /var/www/html/hawaii/asistencia/backend
   npm install -D @playwright/test
   npx playwright install chromium
   ```

2. Crear configuración playwright.config.ts

   - baseURL: http://localhost (Apache)
   - testDir: tests/e2e/
   - timeout: 30000ms
   - retries: 0 (evitar flaky tests enmascarados)
   - workers: 1 (evitar race conditions en BD)

3. Crear estructura tests/e2e/
   ```
   tests/e2e/
   ├── playwright.config.ts
   ├── fixtures/
   │   └── test-data.ts
   ├── profesor-flow.spec.ts
   ├── estudiante-flow.spec.ts
   └── helpers/
       └── auth.ts
   ```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 2: Test Flujo Profesor (estimado 2-3h)

**Objetivo:** Automatizar validación flujo completo profesor desde main_curso.php hasta proyección QR.

**Escenario de prueba:**

1. Login como profesor en sistema legacy
2. Navegar a main_curso.php con curso asignado
3. Verificar botón "Nuevo Sistema de Asistencia" visible
4. Click en botón → Modal abierto
5. Verificar JWT generado correctamente
6. Verificar iframe carga qr-host
7. Verificar QR visible en proyección
8. Validar WebSocket conectado
9. Esperar 10s → Verificar QR cambia (TOTP rotation)
10. Cerrar modal → WebSocket desconectado

**Código base:**

```typescript
// tests/e2e/profesor-flow.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Flujo Profesor - Proyección QR", () => {
  test("profesor puede abrir sesión y proyectar QR dinámico", async ({
    page,
  }) => {
    // 1. Login como profesor
    await page.goto("/");
    // ... autenticación

    // 2. Navegar a curso
    await page.goto("/main_curso.php?id_curso=123&id_semestre=456");

    // 3. Verificar botón visible
    const button = page.locator("#main_curso_nuevo_sistema_asistencia");
    await expect(button).toBeVisible();

    // 4. Click y verificar modal
    await button.click();
    // ... resto del flujo
  });
});
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 3: Test Flujo Estudiante (estimado 2-3h)

**Objetivo:** Automatizar validación flujo completo estudiante desde horario.php hasta registro asistencia.

**Escenario de prueba:**

1. Login como estudiante en sistema legacy
2. Navegar a horario.php
3. Verificar botón "Tomar Asistencia" visible
4. Click en botón → Modal abierto
5. Verificar JWT generado correctamente
6. Verificar iframe carga qr-reader
7. Simular escaneo QR válido
8. Verificar registro en BD (tabla alumno_asistencia)
9. Verificar redirect a encuesta (asist0.php)

**Código base:**

```typescript
// tests/e2e/estudiante-flow.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Flujo Estudiante - Registro Asistencia", () => {
  test("estudiante puede registrar asistencia escaneando QR", async ({
    page,
    context,
  }) => {
    // 1. Login como estudiante
    await page.goto("/");
    // ... autenticación

    // 2. Navegar a horario
    await page.goto("/horario.php");

    // 3. Verificar botón visible
    const button = page.locator("#horario_tomar_asistencia");
    await expect(button).toBeVisible();

    // 4. Simular escaneo
    // ... resto del flujo
  });
});
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 4: CI Integration (estimado 1h)

**Objetivo:** Agregar job test-e2e en GitHub Actions para ejecutar tests Playwright en CI.

**Tareas:**

1. Actualizar .github/workflows/ci.yml
2. Agregar job test-e2e después de test-node
3. Instalar Playwright browsers en CI
4. Levantar servicios necesarios (backend, postgres, valkey)
5. Ejecutar tests con xvfb (headless)
6. Capturar artifacts si fallan (screenshots, videos, traces)

**Código base:**

```yaml
test-e2e:
  runs-on: ubuntu-latest
  needs: [test-node, test-php]
  services:
    postgres:
      image: postgres:18-alpine
      # ... config
    valkey:
      image: valkey/valkey:7-alpine
      # ... config
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Install dependencies
      run: cd backend && npm ci
    - name: Install Playwright
      run: cd backend && npx playwright install --with-deps chromium
    - name: Start backend
      run: cd backend && npm start &
    - name: Run E2E tests
      run: cd backend && npm run test:e2e
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-report
        path: backend/playwright-report/
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 5: Healthcheck Contenedor (estimado 1h)

**Objetivo:** Crear endpoint público /healthz para HEALTHCHECK en Containerfile.

**Tareas:**

1. Crear ruta GET /healthz en backend (sin middleware JWT)
2. Verificar conexiones: PostgreSQL, Valkey
3. Retornar JSON con status y timestamps
4. Actualizar Containerfile con HEALTHCHECK
5. Validar con podman ps (columna STATUS debe mostrar "healthy")

**Código base:**

```typescript
// backend/src/routes/health.ts
app.get("/healthz", async (request, reply) => {
  const checks = {
    postgres: false,
    valkey: false,
  };

  try {
    // Check PostgreSQL
    await db.query("SELECT 1");
    checks.postgres = true;
  } catch (err) {
    // log error
  }

  try {
    // Check Valkey
    await redis.ping();
    checks.valkey = true;
  } catch (err) {
    // log error
  }

  const healthy = checks.postgres && checks.valkey;

  return {
    status: healthy ? "ok" : "degraded",
    timestamp: Date.now(),
    checks,
  };
});
```

**Containerfile:**

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:3000/healthz || exit 1
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 6: Documentación API OpenAPI (estimado 2h)

**Objetivo:** Generar especificación OpenAPI 3.0 para endpoints backend.

**Tareas:**

1. Instalar @fastify/swagger y @fastify/swagger-ui
2. Configurar plugin con metadata del API
3. Agregar schemas a cada endpoint
4. Generar spec en /docs/swagger.json
5. UI disponible en /docs
6. Documentar:
   - POST /api/auth/token
   - GET /api/health
   - GET /healthz
   - WS /ws/qr-projection
   - POST /api/attendance/validate

**Código base:**

```typescript
// backend/src/index.ts
import swagger from "@fastify/swagger";
import swaggerUi from "@fastify/swagger-ui";

await app.register(swagger, {
  openapi: {
    info: {
      title: "Sistema de Asistencia UCN API",
      description: "API para sistema de asistencia con QR criptográfico",
      version: "1.0.0",
    },
    servers: [
      { url: "http://localhost:3000", description: "Development" },
      { url: "https://mantochrisal.cl", description: "Production" },
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: "http",
          scheme: "bearer",
          bearerFormat: "JWT",
        },
      },
    },
  },
});

await app.register(swaggerUi, {
  routePrefix: "/docs",
  uiConfig: {
    docExpansion: "list",
    deepLinking: false,
  },
});
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

### Fase 7: Plan Disk Space Monitoring (estimado 1h)

**Objetivo:** Implementar monitoreo automático de uso de disco y alertas.

**Tareas:**

1. Script bash disk-monitor.sh
2. Verificar uso de disco > 85% → alerta
3. Ejecutar podman system prune automáticamente si > 90%
4. Analizar uso PostgreSQL por tabla
5. Cron job semanal
6. Logging en /var/log/disk-monitor.log

**Código base:**

```bash
#!/bin/bash
# disk-monitor.sh

THRESHOLD=85
CRITICAL=90
LOG_FILE="/var/log/disk-monitor.log"

USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')

echo "[$(date)] Disk usage: ${USAGE}%" >> "$LOG_FILE"

if [ "$USAGE" -gt "$CRITICAL" ]; then
    echo "[$(date)] CRITICAL: Disk usage above ${CRITICAL}%. Running cleanup..." >> "$LOG_FILE"
    podman system prune -af --volumes >> "$LOG_FILE" 2>&1
elif [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "[$(date)] WARNING: Disk usage above ${THRESHOLD}%" >> "$LOG_FILE"
fi
```

**Crontab:**

```cron
# Ejecutar cada domingo a las 3am
0 3 * * 0 /usr/local/bin/disk-monitor.sh
```

**Resultado:**

- PENDIENTE

**Bloqueadores encontrados:**

- Ninguno anticipado

---

## Decisiones Técnicas

### DT-001: Playwright sobre Cypress

**Contexto:** Necesitamos framework E2E para validar flujos browser completos.

**Opciones evaluadas:**
| Framework | Pros | Contras | Decisión |
|------------|-----------------------------------|----------------------------|----------|
| Playwright | Debugging superior, trace viewer | Menos popularidad | SELECCIONADO |
| Cypress | Popular, buena documentación | Debugging limitado | Rechazado |
| Puppeteer | Lightweight | Solo Chromium, menos APIs | Rechazado |

**Justificación:**

- Playwright trace viewer esencial para debugging en CI
- Auto-waiting reduce flaky tests
- Multi-browser support (futuro Safari/Firefox)

**Impacto:** Tests más robustos, menos mantenimiento

---

### DT-002: Workers: 1 en Playwright Config

**Contexto:** Tests E2E pueden tener race conditions en BD.

**Decisión:** Configurar workers: 1 para ejecutar tests secuencialmente.

**Justificación:**

- Evita conflictos en tabla alumno_asistencia
- Simplifica debugging (logs lineales)
- Performance no es crítica (3-4 tests totales)

**Trade-off aceptado:** Tests más lentos pero más confiables.

---

### DT-003: /healthz Sin Autenticación

**Contexto:** Endpoint /health requiere JWT, bloqueando HEALTHCHECK.

**Decisión:** Crear /healthz público específico para health checks.

**Justificación:**

- HEALTHCHECK no puede generar JWT
- /health mantiene seguridad para uso aplicación
- /healthz expone solo info operacional (no datos sensibles)

**Alternativa rechazada:** Eliminar JWT de /health (degrada seguridad)

---

## Bloqueadores y Resoluciones

### Bloqueador 1: Playwright Requiere Display en CI

**Problema:** Tests E2E pueden fallar en CI sin display X11.

**Síntomas:**

- Error "Could not connect to display"
- Tests pasan localmente, fallan en GitHub Actions

**Análisis:**
Chromium requiere display para renderizar, incluso en modo headless.

**Soluciones evaluadas:**
| Opción | Complejidad | Efectividad | Decisión |
|----------------|-------------|-------------|----------|
| xvfb-run | Baja | Alta | SELECCIONADA |
| Docker display | Alta | Media | Rechazada |
| headless: true | Baja | Alta | Incluida en config |

**Resolución implementada:**

```yaml
- name: Run E2E tests
  run: cd backend && xvfb-run npm run test:e2e
```

**Estado:** PENDIENTE (implementar si ocurre)

---

### Bloqueador 2: CORS en Playwright Tests

**Problema:** Iframe qr-host/qr-reader puede tener errores CORS durante tests.

**Resolución preventiva:**
Configurar Apache test environment con CORS permisivo para localhost.

**Estado:** PENDIENTE (validar durante tests)

---

### Bloqueador 3: JWT Expiration en Tests Largos

**Problema:** JWT con TTL 300s puede expirar durante test E2E completo.

**Resolución:**

- Generar nuevo JWT para cada test case
- No reutilizar JWT entre tests

**Estado:** PENDIENTE (implementar en helpers/auth.ts)

---

## Métricas del Día

**Tiempo invertido:** 0h / 10h estimadas

**Código generado:**

- TypeScript: 0 líneas
- YAML: 0 líneas
- Bash: 0 líneas

**Tests implementados:**

- E2E Playwright: 0/4
- CI jobs: 0/1

**Documentación:**

- OpenAPI spec: 0% completitud

**Infraestructura:**

- Healthcheck: NO implementado
- Disk monitoring: NO implementado

---

## Aprendizajes

_(Completar al final del día)_

---

## Próximos Pasos (Día 5)

### Objetivos Día 5

1. **Validación Manual Requisitos Funcionales (4h)**

   - Ejecutar checklist 7 requisitos
   - Capturar evidencias (screenshots, queries, videos)
   - Documentar resultados en matriz de trazabilidad

2. **Optimizaciones Performance (2h)**

   - Agregar índices faltantes en PostgreSQL
   - Analizar queries N+1 con EXPLAIN
   - Configurar connection pool size

3. **Logging Estructurado (2h)**
   - Implementar pino logger en backend
   - Structured JSON logs
   - Rotación diaria con logrotate

### Bloqueadores Anticipados

**Riesgo:** Tests E2E pueden revelar bugs no detectados en tests unitarios

- Mitigación: Resolver inmediatamente, priorizar sobre nuevas features

**Riesgo:** OpenAPI spec puede desviarse de implementación real

- Mitigación: Validar cada endpoint contra spec generada

**Riesgo:** Disk space puede volver a alcanzar 90%+

- Mitigación: Script de monitoreo debe ejecutarse inmediatamente

---

## Conclusiones del Día 4

**Estado:** PENDIENTE (inicio de día)

**Objetivo crítico:** Tests E2E funcionando y documentación API completa

**Dependencias resueltas:** Backend staging funcional (Día 3)

**Próximo hito:** Validación requisitos funcionales (Día 5-6)
