name: CI - Sistema de Asistencia

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancela workflows anteriores si hay un nuevo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Tests de Node.js/TypeScript (Backend Fastify + Frontend)
  test-node:
    name: Tests Node.js (Vitest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js 20 (mÃ©todo estÃ¡ndar GitHub Actions)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: node-service/package-lock.json

      - name: Instalar dependencias
        working-directory: node-service
        run: npm ci

      - name: Type checking (TypeScript)
        working-directory: node-service
        run: npm run type-check

      - name: Ejecutar tests con Vitest
        working-directory: node-service
        run: npm run test:coverage
        env:
          # Variables de entorno necesarias para tests
          JWT_SECRET: test_secret_for_ci
          JWT_SECRET_INTERNAL: test_internal_secret_for_ci
          SERVER_MASTER_SECRET: test_master_secret_for_ci
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: asistencia_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          VALKEY_HOST: localhost
          VALKEY_PORT: 6379

      - name: Subir reporte de cobertura
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./node-service/coverage/coverage-final.json
          flags: node-service
          name: codecov-node-service
          fail_ci_if_error: false

      - name: Generar resumen de cobertura
        if: always()
        working-directory: node-service
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## ðŸ“Š Cobertura de Tests Node.js" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Tests PHP (PHPUnit)
  test-php:
    name: Tests PHP (PHPUnit)
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    strategy:
      matrix:
        php-version: ["7.4", "8.0", "8.1"]

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar PHP ${{ matrix.php-version }} en Rocky Linux
        run: |
          dnf install -y --allowerasing epel-release git
          dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
          dnf module reset php -y
          dnf module enable php:remi-${{ matrix.php-version }} -y
          dnf install -y php php-mbstring php-pdo php-pgsql php-json php-xml php-pecl-xdebug
          php --version
          # Instalar Composer manualmente
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer --version

      - name: Validar composer.json
        working-directory: php-service
        run: |
          if [ -f composer.json ]; then
            composer validate --strict
          else
            echo "âš ï¸ composer.json no encontrado - saltando validaciÃ³n"
          fi

      - name: Instalar dependencias PHP
        working-directory: php-service
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-suggest
          else
            echo "âš ï¸ composer.json no encontrado - saltando instalaciÃ³n"
          fi

      - name: Ejecutar tests PHPUnit
        working-directory: php-service
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
          else
            echo "âš ï¸ PHPUnit no instalado aÃºn - tests PHP pendientes de implementaciÃ³n (DÃ­a 1-2)"
            echo "ðŸ“‹ Tareas planificadas: 115+ tests PHP (>80% cobertura)"
            exit 0
          fi

      - name: Subir cobertura PHP
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./php-service/coverage.xml
          flags: php-service
          name: codecov-php-service
          fail_ci_if_error: false

  # Job 3: Linting y Formateo
  lint:
    name: Linting y Code Style
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: node-service/package-lock.json

      - name: Instalar dependencias Node
        working-directory: node-service
        run: npm ci

      - name: Verificar formato de cÃ³digo (ESLint)
        working-directory: node-service
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ] || [ -f eslint.config.js ]; then
            npm run lint || echo "âš ï¸ ESLint no configurado aÃºn"
          else
            echo "â„¹ï¸ ESLint pendiente de configuraciÃ³n"
          fi

      - name: Instalar PHP para linting
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: php-cs-fixer

      - name: Verificar estilo PHP (PHP CS Fixer)
        working-directory: php-service
        run: |
          if [ -f .php-cs-fixer.php ]; then
            php-cs-fixer fix --dry-run --diff --verbose
          else
            echo "â„¹ï¸ PHP CS Fixer pendiente de configuraciÃ³n"
          fi

  # Job 4: Build verification (asegurar que el build funciona)
  build:
    name: Verificar Build
    runs-on: ubuntu-latest
    needs: [test-node, test-php]

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: node-service/package-lock.json

      - name: Instalar dependencias
        working-directory: node-service
        run: npm ci

      - name: Build backend + frontend
        working-directory: node-service
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verificar artefactos generados
        working-directory: node-service
        run: |
          echo "## ðŸ“¦ Artefactos Generados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d dist ]; then
            echo "âœ… Directorio dist/ creado" >> $GITHUB_STEP_SUMMARY
            
            if [ -f dist/index.js ]; then
              echo "âœ… Backend compilado: dist/index.js" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Backend NO compilado: dist/index.js no encontrado" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -d dist/frontend ]; then
              echo "âœ… Frontend compilado: dist/frontend/" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ls -lh dist/frontend/ >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Frontend NO compilado: dist/frontend/ no encontrado" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Directorio dist/ no creado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Guardar artefactos de build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: node-service/dist/
          retention-days: 7

  # Job 5: Resumen final
  summary:
    name: Resumen CI
    runs-on: ubuntu-latest
    needs: [test-node, test-php, lint, build]
    if: always()

    steps:
      - name: Generar resumen
        run: |
          echo "# ðŸŽ¯ Resumen de CI - Sistema de Asistencia" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Node.js | ${{ needs.test-node.result == 'success' && 'âœ… Exitoso' || 'âŒ Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests PHP | ${{ needs.test-php.result == 'success' && 'âœ… Exitoso' || 'âŒ Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result == 'success' && 'âœ… Exitoso' || 'âŒ Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Exitoso' || 'âŒ Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Autor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
