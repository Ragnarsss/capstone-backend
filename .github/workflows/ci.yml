name: CI - Sistema de Asistencia

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancela workflows anteriores si hay un nuevo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Tests de Node.js/TypeScript (Backend Fastify + Frontend)
  test-node:
    name: Tests Node.js (Vitest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20 (método estándar GitHub Actions)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias
        working-directory: backend
        run: npm ci

      - name: Type checking (TypeScript)
        working-directory: backend
        run: npm run type-check

      - name: Ejecutar tests con Vitest
        working-directory: backend
        run: npm run test:coverage
        env:
          # Variables de entorno necesarias para tests
          JWT_SECRET: test_secret_for_ci
          JWT_SECRET_INTERNAL: test_internal_secret_for_ci
          SERVER_MASTER_SECRET: test_master_secret_for_ci
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: asistencia_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          VALKEY_HOST: localhost
          VALKEY_PORT: 6379

      - name: Subir reporte de cobertura
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: codecov-backend
          fail_ci_if_error: false

      - name: Generar resumen de cobertura
        if: always()
        working-directory: backend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Cobertura de Tests Node.js" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parsear JSON y crear tabla Markdown
            total_lines=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            total_statements=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            total_functions=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            total_branches=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            
            echo "| Métrica | Cobertura |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Líneas | ${total_lines}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${total_statements}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Funciones | ${total_functions}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${total_branches}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Top 5 archivos con mejor cobertura
            echo "### ✓ Top 5 Archivos con Mejor Cobertura" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries | 
                   map(select(.key != "total")) | 
                   sort_by(-.value.lines.pct) | 
                   limit(5;.[]) | 
                   "- \(.key | split("/") | last): **\(.value.lines.pct)%** coverage"' \
                   coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Archivos que necesitan atención (< 80%)
            low_coverage=$(jq -r 'to_entries | 
                                   map(select(.key != "total" and .value.lines.pct < 80)) | 
                                   length' coverage/coverage-summary.json)
            
            if [ "$low_coverage" -gt 0 ]; then
              echo "### ! Archivos que Necesitan Más Tests (< 80%)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r 'to_entries | 
                     map(select(.key != "total" and .value.lines.pct < 80)) | 
                     sort_by(.value.lines.pct) | 
                     limit(5;.[]) | 
                     "- \(.key | split("/") | last): **\(.value.lines.pct)%** coverage"' \
                     coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[Ver reporte HTML completo](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Subir reporte HTML de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-node
          path: backend/coverage/
          retention-days: 30

  # Job 2: Tests PHP (PHPUnit)
  test-php:
    name: Tests PHP (PHPUnit)
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    strategy:
      matrix:
        php-version: ["7.4", "8.0", "8.1"]

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar PHP ${{ matrix.php-version }} en Rocky Linux
        run: |
          dnf install -y --allowerasing epel-release git
          dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
          dnf module reset php -y
          dnf module enable php:remi-${{ matrix.php-version }} -y
          dnf install -y php php-mbstring php-pdo php-pgsql php-json php-xml php-pecl-xdebug
          php --version
          # Instalar Composer manualmente
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer --version

      - name: Validar composer.json
        working-directory: php-service
        run: |
          if [ -f composer.json ]; then
            composer validate --no-check-all --no-check-publish
          else
            echo "[!] composer.json no encontrado - saltando validación"
          fi

      - name: Instalar dependencias PHP
        working-directory: php-service
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-suggest
          else
            echo "[!] composer.json no encontrado - saltando instalación"
          fi

      - name: Ejecutar tests PHPUnit
        working-directory: php-service
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
          else
            echo "[!] PHPUnit no instalado aún - tests PHP pendientes de implementación (Día 1-2)"
            echo "[*] Tareas planificadas: 115+ tests PHP (>80% cobertura)"
            exit 0
          fi

      - name: Subir cobertura PHP
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./php-service/coverage.xml
          flags: php-service
          name: codecov-php-service
          fail_ci_if_error: false

  # Job 3: Linting y Formateo
  lint:
    name: Linting y Code Style
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias Node
        working-directory: backend
        run: npm ci

      - name: Verificar formato de código (ESLint)
        working-directory: backend
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ] || [ -f eslint.config.js ]; then
            npm run lint || echo "[!] ESLint no configurado aún"
          else
            echo "[i] ESLint pendiente de configuración"
          fi

      - name: Instalar PHP para linting
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          tools: php-cs-fixer

      - name: Verificar estilo PHP (PHP CS Fixer)
        working-directory: php-service
        run: |
          if [ -f .php-cs-fixer.php ]; then
            php-cs-fixer fix --dry-run --diff --verbose
          else
            echo "[i] PHP CS Fixer pendiente de configuración"
          fi

  # Job 4: Build verification (asegurar que el build funciona)
  build:
    name: Verificar Build
    runs-on: ubuntu-latest
    needs: [test-node, test-php]

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias backend
        working-directory: backend
        run: npm ci

      - name: Instalar dependencias frontend
        working-directory: frontend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verificar artefactos backend
        working-directory: backend
        run: |
          echo "## Artefactos Backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d dist ]; then
            echo "[OK] Backend dist/ creado" >> $GITHUB_STEP_SUMMARY
            
            if [ -f dist/index.js ]; then
              echo "[OK] Backend compilado: dist/index.js" >> $GITHUB_STEP_SUMMARY
            else
              echo "[ERROR] Backend NO compilado: dist/index.js no encontrado" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "[ERROR] Directorio dist/ no creado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Verificar artefactos frontend
        working-directory: frontend
        run: |
          echo "## Artefactos Frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d dist ]; then
            echo "[OK] Frontend dist/ creado" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh dist/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] Frontend dist/ no creado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Guardar artefactos backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifacts
          path: backend/dist/
          retention-days: 7

      - name: Guardar artefactos frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts
          path: frontend/dist/
          retention-days: 7

  # Job 5: Resumen final
  summary:
    name: Resumen CI
    runs-on: ubuntu-latest
    needs: [test-node, test-php, lint, build]
    if: always()

    steps:
      - name: Generar resumen
        run: |
          echo "# Resumen de CI - Sistema de Asistencia" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Node.js | ${{ needs.test-node.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests PHP | ${{ needs.test-php.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Autor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
