name: CI - Sistema de Asistencia

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancela workflows anteriores si hay un nuevo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Tests de Node.js/TypeScript (Backend Fastify + Frontend)
  test-node:
    name: Tests Node.js (Vitest)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: asistencia_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      valkey:
        image: valkey/valkey:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "valkey-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20 (método estándar GitHub Actions)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias
        working-directory: backend
        run: npm ci

      - name: Type checking (TypeScript)
        working-directory: backend
        run: npm run type-check

      - name: Ejecutar tests con Vitest
        working-directory: backend
        run: npm run test:coverage
        env:
          # Variables de entorno necesarias para tests
          JWT_SECRET: test_secret_for_ci
          JWT_SECRET_INTERNAL: test_internal_secret_for_ci
          SERVER_MASTER_SECRET: test_master_secret_for_ci
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: asistencia_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          VALKEY_HOST: localhost
          VALKEY_PORT: 6379

      - name: Subir reporte de cobertura
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: codecov-backend
          fail_ci_if_error: false

      - name: Generar resumen de cobertura
        if: always()
        working-directory: backend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Cobertura de Tests Node.js" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parsear JSON y crear tabla Markdown
            total_lines=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            total_statements=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            total_functions=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            total_branches=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            
            echo "| Métrica | Cobertura |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Líneas | ${total_lines}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${total_statements}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Funciones | ${total_functions}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${total_branches}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Top 5 archivos con mejor cobertura
            echo "### ✓ Top 5 Archivos con Mejor Cobertura" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries | 
                   map(select(.key != "total")) | 
                   sort_by(-.value.lines.pct) | 
                   limit(5;.[]) | 
                   "- \(.key | split("/") | last): **\(.value.lines.pct)%** coverage"' \
                   coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Archivos que necesitan atención (< 80%)
            low_coverage=$(jq -r 'to_entries | 
                                   map(select(.key != "total" and .value.lines.pct < 80)) | 
                                   length' coverage/coverage-summary.json)
            
            if [ "$low_coverage" -gt 0 ]; then
              echo "### ! Archivos que Necesitan Más Tests (< 80%)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r 'to_entries | 
                     map(select(.key != "total" and .value.lines.pct < 80)) | 
                     sort_by(.value.lines.pct) | 
                     limit(5;.[]) | 
                     "- \(.key | split("/") | last): **\(.value.lines.pct)%** coverage"' \
                     coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[Ver reporte HTML completo](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Subir reporte HTML de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-node
          path: backend/coverage/
          retention-days: 30

  # Job 2: Tests PHP (PHPUnit)
  test-php:
    name: Tests PHP (PHPUnit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup PHP 7.4 con PCOV
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          extensions: mbstring, pdo, pgsql, json, xml, pcov
          coverage: pcov
          tools: composer:v2

      - name: Validar composer.json
        working-directory: php-service
        run: composer validate --no-check-all --no-check-publish

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: php-service/vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias PHP
        working-directory: php-service
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Ejecutar tests PHPUnit con coverage
        working-directory: php-service
        run: |
          php -d pcov.enabled=1 -d pcov.directory=./src vendor/bin/phpunit \
            --coverage-text \
            --coverage-clover=coverage.xml \
            --coverage-html=coverage/html \
            --testdox

      - name: Verificar umbral de cobertura mínima
        working-directory: php-service
        run: |
          # Extraer porcentaje de cobertura de lines
          coverage=$(php -r '
            $xml = simplexml_load_file("coverage.xml");
            $metrics = $xml->project->metrics;
            $lines = (int)$metrics["coveredstatements"];
            $total = (int)$metrics["statements"];
            echo round(($lines / $total) * 100, 2);
          ')

          echo "Cobertura actual: ${coverage}%"
          echo "Umbral mínimo: 50%"

          if (( $(echo "$coverage < 50" | bc -l) )); then
            echo "❌ Cobertura por debajo del umbral mínimo"
            exit 1
          else
            echo "✅ Cobertura cumple con el umbral mínimo"
          fi

      - name: Generar resumen de cobertura PHP
        if: always()
        working-directory: php-service
        run: |
          echo "## Cobertura de Tests PHP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage.xml ]; then
            # Parsear XML y mostrar métricas
            php -r '
              $xml = simplexml_load_file("coverage.xml");
              $metrics = $xml->project->metrics;
              
              $statements = (int)$metrics["statements"];
              $covered_statements = (int)$metrics["coveredstatements"];
              $methods = (int)$metrics["methods"];
              $covered_methods = (int)$metrics["coveredmethods"];
              $classes = (int)$metrics["classes"];
              $covered_classes = (int)$metrics["coveredclasses"];
              
              $line_coverage = round(($covered_statements / $statements) * 100, 2);
              $method_coverage = round(($covered_methods / $methods) * 100, 2);
              $class_coverage = $classes > 0 ? round(($covered_classes / $classes) * 100, 2) : 0;
              
              echo "| Métrica | Cobertura |\n";
              echo "|---------|-----------|" . PHP_EOL;
              echo "| Líneas | {$line_coverage}% ({$covered_statements}/{$statements}) |" . PHP_EOL;
              echo "| Métodos | {$method_coverage}% ({$covered_methods}/{$methods}) |" . PHP_EOL;
              echo "| Clases | {$class_coverage}% ({$covered_classes}/{$classes}) |" . PHP_EOL;
            ' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tests ejecutados:** $(grep -o 'tests="[0-9]*"' coverage.xml | grep -o '[0-9]*')" >> $GITHUB_STEP_SUMMARY
            echo "**Aserciones:** $(grep -o 'assertions="[0-9]*"' coverage.xml | grep -o '[0-9]*')" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Subir cobertura PHP a Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./php-service/coverage.xml
          flags: php-service
          name: codecov-php-service
          fail_ci_if_error: false

      - name: Subir reporte HTML de cobertura PHP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-php
          path: php-service/coverage/
          retention-days: 30

  # Job 3: Linting y Formateo
  lint:
    name: Linting y Code Style
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias Node
        working-directory: backend
        run: npm ci

      - name: Verificar formato de código (ESLint)
        working-directory: backend
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ] || [ -f eslint.config.js ]; then
            npm run lint || echo "[!] ESLint no configurado aún"
          else
            echo "[i] ESLint pendiente de configuración"
          fi

      - name: Instalar PHP para linting
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          tools: php-cs-fixer

      - name: Verificar estilo PHP (PHP CS Fixer)
        working-directory: php-service
        run: |
          if [ -f .php-cs-fixer.php ]; then
            php-cs-fixer fix --dry-run --diff --verbose
          else
            echo "[i] PHP CS Fixer pendiente de configuración"
          fi

  # Job 4: Security & Dependencies
  security:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Audit vulnerabilidades backend
        working-directory: backend
        run: |
          echo "## Security Audit Backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm audit --audit-level=moderate || echo "Vulnerabilidades encontradas"
          
          # Contar vulnerabilidades
          critical=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0')
          high=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0')
          moderate=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.moderate // 0')
          
          echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${critical} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${high} |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | ${moderate} |" >> $GITHUB_STEP_SUMMARY
          
          # Fallar si hay critical o high
          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[FAIL] Vulnerabilidades críticas o altas encontradas" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Audit vulnerabilidades frontend
        working-directory: frontend
        run: |
          echo "## Security Audit Frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm audit --audit-level=moderate || echo "Vulnerabilidades encontradas"
          
          critical=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0')
          high=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0')
          
          echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${critical} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${high} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "[FAIL] Vulnerabilidades críticas o altas" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check outdated dependencies
        working-directory: backend
        run: |
          echo "## Dependencias Desactualizadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 5: Build verification (asegurar que el build funciona)
  build:
    name: Verificar Build
    runs-on: ubuntu-latest
    needs: [test-node, test-php, security]

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias backend
        working-directory: backend
        run: npm ci

      - name: Instalar dependencias frontend
        working-directory: frontend
        run: npm ci

      - name: Validar backend tsx runtime
        working-directory: backend
        run: |
          echo "## Validacion Backend (tsx runtime)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verificar que tsx esta instalado
          if npm list tsx > /dev/null 2>&1; then
            echo "- [OK] tsx runtime instalado" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ERROR] tsx runtime NO instalado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verificar que el punto de entrada existe
          if [ -f src/index.ts ]; then
            echo "- [OK] Punto de entrada: src/index.ts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ERROR] src/index.ts no encontrado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verificar que no hay build script innecesario
          if grep -q '"build":.*"tsc"' package.json 2>/dev/null; then
            echo "- [WARNING] package.json tiene build script con tsc (no usado en produccion)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime:** tsx (ejecucion directa de TypeScript)" >> $GITHUB_STEP_SUMMARY

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verificar artefactos frontend
        working-directory: frontend
        run: |
          echo "## Artefactos Frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d dist ]; then
            echo "[OK] Frontend dist/ creado" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh dist/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] Frontend dist/ no creado" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Guardar artefactos frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts
          path: frontend/dist/
          retention-days: 7

  # Job 6: Resumen final
  summary:
    name: Resumen CI
    runs-on: ubuntu-latest
    needs: [test-node, test-php, lint, security, build]
    if: always()

    steps:
      - name: Generar resumen
        run: |
          echo "# Resumen de CI - Sistema de Asistencia" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Node.js | ${{ needs.test-node.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests PHP | ${{ needs.test-php.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '[OK] Sin vulnerabilidades' || '[FAIL] Vulnerabilidades detectadas' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '[OK] Exitoso' || '[FAIL] Fallido' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Autor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
