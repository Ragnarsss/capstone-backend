# Configuracion de Apache para proxy de WebSocket al servicio Node.js

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Proxy inverso para el servicio Node.js
    # Redirige /asistencia/* al contenedor node-service
    ProxyPreserveHost On

    # ========================================
    # Arquitectura JWT Recomendada
    # ========================================
    # Ruta /minodo-api/* - Cliente habla DIRECTAMENTE con Node.js usando JWT
    # El cliente primero obtiene JWT desde api_puente_minodo.php,
    # luego usa este endpoint para comunicarse con Node.js
    #
    # Ejemplo: /minodo-api/enrollment/start -> http://node-service:3000/api/enrollment/start
    ProxyPass /minodo-api http://node-service:3000/api
    ProxyPassReverse /minodo-api http://node-service:3000/api

    # ========================================
    # Recursos Estáticos del Iframe (CSS, JS)
    # ========================================
    # Proxy para archivos estáticos del frontend de Node.js
    # Estos son solicitados por el index.html dentro del iframe /asistencia/
    # Incluye: base.css, qr-projection.styles.css, main.js, etc.
    ProxyPass /frontend http://node-service:3000/frontend
    ProxyPassReverse /frontend http://node-service:3000/frontend

    # ========================================
    # Rutas Legacy (WebSocket + iframe)
    # ========================================
    # Proxy WebSocket - DEBE ir ANTES del proxy HTTP general
    # La regla mas especifica debe estar primero
    ProxyPass /asistencia/ws ws://node-service:3000/ws
    ProxyPassReverse /asistencia/ws ws://node-service:3000/ws

    # Proxy HTTP normal - va despues del WebSocket
    ProxyPass /asistencia http://node-service:3000
    ProxyPassReverse /asistencia http://node-service:3000

    # Logs
    ErrorLog /var/log/httpd/error.log
    CustomLog /var/log/httpd/access.log combined
</VirtualHost>
