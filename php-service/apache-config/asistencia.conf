# Configuracion de Apache para proxy de WebSocket al servicio Node.js

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Proxy inverso para el servicio Node.js
    # Redirige /asistencia/* al contenedor node-service
    ProxyPreserveHost On

    # ========================================
    # Módulo de Integración PHP-Node
    # ========================================
    # Alias para el módulo de integración autocontenido
    # Maneja autenticación JWT y comunicación bidireccional
    Alias /asistencia-node-integration /var/www/html/asistencia-node-integration

    <Directory /var/www/html/asistencia-node-integration>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Rewrite para API endpoints (delegación a index.php)
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^api/(.*)$ index.php [L,QSA]
        </IfModule>
    </Directory>

    # ========================================
    # Arquitectura JWT Recomendada
    # ========================================
    # Ruta /minodo-api/* - Cliente habla DIRECTAMENTE con Node.js usando JWT
    # El cliente primero obtiene JWT desde asistencia-node-integration/api/token,
    # luego usa este endpoint para comunicarse con Node.js
    #
    # Ejemplo: /minodo-api/enrollment/start -> http://node-service:3000/api/enrollment/start
    ProxyPass /minodo-api http://node-service:3000/api
    ProxyPassReverse /minodo-api http://node-service:3000/api

    # ========================================
    # Recursos Estáticos del Iframe (CSS, JS)
    # ========================================
    # Proxy para archivos estáticos del frontend de Node.js
    # Estos son solicitados por el index.html dentro del iframe /asistencia/
    # Incluye: base.css, qr-projection.styles.css, main.js, etc.
    ProxyPass /frontend http://node-service:3000/frontend
    ProxyPassReverse /frontend http://node-service:3000/frontend

    # ========================================
    # Rutas Legacy (WebSocket + iframe)
    # ========================================
    # Proxy WebSocket - DEBE ir ANTES del proxy HTTP general
    # La regla mas especifica debe estar primero
    ProxyPass /asistencia/ws ws://node-service:3000/asistencia/ws
    ProxyPassReverse /asistencia/ws ws://node-service:3000/asistencia/ws

    # Proxy HTTP - Preserva el path completo /asistencia/* para que Vite lo reciba
    # Vite está configurado con base: '/asistencia/' y espera rutas con ese prefijo
    # Trailing slash es importante
    ProxyPass /asistencia/ http://node-service:3000/asistencia/
    ProxyPassReverse /asistencia/ http://node-service:3000/asistencia/
    
    # Ruta sin trailing slash tambien debe funcionar
    ProxyPass /asistencia http://node-service:3000/asistencia
    ProxyPassReverse /asistencia http://node-service:3000/asistencia

    # Logs
    ErrorLog /var/log/httpd/error.log
    CustomLog /var/log/httpd/access.log combined
</VirtualHost>
