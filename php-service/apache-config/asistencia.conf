# Configuracion HTTP de Apache para proxy al servicio Node.js

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ProxyPreserveHost On

    # ========================================
    # Dev Simulator (solo desarrollo)
    # ========================================
    Alias /dev-simulator /var/www/html/dev-simulator

    <Directory /var/www/html/dev-simulator>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ========================================
    # Modulo de Integracion PHP-Node
    # ========================================
    # Endpoint unico para JWT: /asistencia-node-integration/api/token
    Alias /asistencia-node-integration /var/www/html/asistencia-node-integration

    <Directory /var/www/html/asistencia-node-integration>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^api/(.*)$ index.php [L,QSA]
        </IfModule>
    </Directory>

    # ========================================
    # Proxy a Node.js (interno, no expuesto)
    # ========================================
    # WebSocket - DEBE ir ANTES del proxy HTTP
    ProxyPass /asistencia/ws ws://node-service:3000/asistencia/ws
    ProxyPassReverse /asistencia/ws ws://node-service:3000/asistencia/ws

    # Frontend Node.js (host y reader via iframe)
    ProxyPass /asistencia/ http://node-service:3000/asistencia/
    ProxyPassReverse /asistencia/ http://node-service:3000/asistencia/
    
    ProxyPass /asistencia http://node-service:3000/asistencia
    ProxyPassReverse /asistencia http://node-service:3000/asistencia

    # API Node.js (para llamadas desde frontend embebido)
    # /minodo-api/* -> /api/*
    ProxyPass /minodo-api/ http://node-service:3000/api/
    ProxyPassReverse /minodo-api/ http://node-service:3000/api/

    # Logs
    ErrorLog /var/log/httpd/error.log
    CustomLog /var/log/httpd/access.log combined
</VirtualHost>
