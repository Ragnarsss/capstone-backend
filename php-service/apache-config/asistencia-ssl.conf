# Configuracion HTTPS de Apache para proxy al servicio Node.js
# Certificado autofirmado para testing en dispositivos moviles

Listen 443 https

<VirtualHost *:443>
    ServerName localhost
    DocumentRoot /var/www/html

    # Configuracion SSL
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/asistencia.crt
    SSLCertificateKeyFile /etc/pki/tls/private/asistencia.key

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ProxyPreserveHost On

    # ========================================
    # Dev Simulator (solo desarrollo)
    # ========================================
    Alias /dev-simulator /var/www/html/dev-simulator

    <Directory /var/www/html/dev-simulator>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ========================================
    # Modulo de Integracion PHP-Node
    # ========================================
    # Endpoint unico para JWT: /asistencia-node-integration/api/token
    Alias /asistencia-node-integration /var/www/html/asistencia-node-integration

    <Directory /var/www/html/asistencia-node-integration>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^api/(.*)$ index.php [L,QSA]
        </IfModule>
    </Directory>

    # ========================================
    # Proxy a Node.js (interno, no expuesto)
    # ========================================
    # WebSocket - DEBE ir ANTES del proxy HTTP
    ProxyPass /asistencia/ws ws://asistencia-node:3000/asistencia/ws
    ProxyPassReverse /asistencia/ws ws://asistencia-node:3000/asistencia/ws

    # Proxy unificado: todo bajo /asistencia/*
    # Incluye frontend (qr-host, qr-reader) y API (/asistencia/api/*)
    ProxyPass /asistencia/ http://asistencia-node:3000/asistencia/
    ProxyPassReverse /asistencia/ http://asistencia-node:3000/asistencia/
    
    ProxyPass /asistencia http://asistencia-node:3000/asistencia
    ProxyPassReverse /asistencia http://asistencia-node:3000/asistencia

    # Logs
    ErrorLog /var/log/httpd/error_ssl.log
    CustomLog /var/log/httpd/access_ssl.log combined
</VirtualHost>
