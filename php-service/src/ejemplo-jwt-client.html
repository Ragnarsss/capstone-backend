<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejemplo: Cliente JWT - Arquitectura Recomendada</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .info {
            color: #2196f3;
        }

        .warning {
            color: #ff9800;
        }

        .flow {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .flow-step {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .flow-arrow {
            font-size: 24px;
            margin: 0 10px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ejemplo: Arquitectura JWT Recomendada</h1>
        <p class="subtitle">
            Demostración del patrón: Cliente → PHP (obtiene JWT) → Cliente → Node (con JWT)
        </p>

        <!-- Flujo visual -->
        <div class="section">
            <h2>Flujo de Autenticación</h2>
            <div class="flow">
                <div class="flow-step">
                    <strong>1. Cliente</strong><br>
                    Solicita JWT a PHP
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-step">
                    <strong>2. PHP</strong><br>
                    Valida sesión y emite JWT
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-step">
                    <strong>3. Cliente</strong><br>
                    Llama a Node con JWT
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-step">
                    <strong>4. Node</strong><br>
                    Valida JWT y responde
                </div>
            </div>
        </div>

        <!-- Paso 1: Obtener JWT -->
        <div class="section">
            <h2>Paso 1: Obtener JWT desde PHP</h2>
            <button onclick="getJWTFromPHP()">Obtener JWT</button>
            <button onclick="clearLog('log1')">Limpiar</button>
            <div id="log1" class="output">Esperando acción...</div>
        </div>

        <!-- Paso 2: Llamar a Node.js con JWT -->
        <div class="section">
            <h2>Paso 2: Llamar a Node.js con JWT</h2>
            <button onclick="callNodeWithJWT('/api/enrollment/status')">Check Enrollment Status</button>
            <button onclick="callNodeWithJWT('/api/enrollment/start')">Start Enrollment</button>
            <button onclick="clearLog('log2')">Limpiar</button>
            <div id="log2" class="output">Esperando acción...</div>
        </div>

        <!-- Paso 3: Flujo completo -->
        <div class="section">
            <h2>Paso 3: Flujo Completo (Automático)</h2>
            <button onclick="fullFlow()">Ejecutar Flujo Completo</button>
            <button onclick="clearLog('log3')">Limpiar</button>
            <div id="log3" class="output">Esperando acción...</div>
        </div>
    </div>

    <script>
        // Variable global para almacenar el JWT
        let jwtToken = null;

        /**
         * Función para simular sesión PHP (SOLO PARA TESTING)
         * En producción, la sesión PHP ya existe del login real
         */
        function setupMockSession() {
            // Simular que el usuario está logueado en PHP
            // En producción, esto YA existe por el login legacy
            console.log('[Mock] Simulando sesión PHP activa');
        }

        /**
         * Paso 1: Obtener JWT desde PHP
         */
        async function getJWTFromPHP() {
            const log = document.getElementById('log1');
            log.innerHTML = '<span class="info">→ Solicitando JWT a PHP...</span>\n';

            try {
                // Llamar a api_puente_minodo.php
                const response = await fetch('/api_puente_minodo.php?action=get_token', {
                    method: 'GET',
                    credentials: 'include', // Incluir cookies de sesión PHP
                });

                const data = await response.json();

                if (data.success) {
                    jwtToken = data.token;

                    log.innerHTML += '<span class="success">✓ JWT obtenido exitosamente</span>\n\n';
                    log.innerHTML += `<span class="info">Token:</span>\n${jwtToken.substring(0, 50)}...\n\n`;
                    log.innerHTML += `<span class="info">User ID:</span> ${data.userId}\n`;
                    log.innerHTML += `<span class="info">Username:</span> ${data.username}\n`;
                    log.innerHTML += `<span class="info">Expira en:</span> ${data.expiresIn}s\n`;
                } else {
                    log.innerHTML += `<span class="error">✗ Error: ${data.message}</span>\n`;
                    log.innerHTML += `<span class="warning">Probablemente no hay sesión PHP activa.</span>\n`;
                    log.innerHTML += `<span class="warning">En producción, el usuario debe estar logueado.</span>\n`;
                }
            } catch (error) {
                log.innerHTML += `<span class="error">✗ Error de red: ${error.message}</span>\n`;
            }
        }

        /**
         * Paso 2: Llamar a Node.js con JWT
         */
        async function callNodeWithJWT(endpoint) {
            const log = document.getElementById('log2');

            if (!jwtToken) {
                log.innerHTML = '<span class="error">✗ Primero debes obtener un JWT (Paso 1)</span>\n';
                return;
            }

            log.innerHTML = `<span class="info">→ Llamando a Node.js: ${endpoint}</span>\n`;

            try {
                // Llamar a Node.js a través del reverse proxy de Apache
                // /minodo-api/* -> http://node-service:3000/api/*
                const response = await fetch(`/minodo-api${endpoint.replace('/api', '')}`, {
                    method: endpoint.includes('start') ? 'POST' : 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: endpoint.includes('start') ? JSON.stringify({
                        displayName: 'Usuario de Prueba'
                    }) : undefined,
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    log.innerHTML += '<span class="success">✓ Node.js respondió exitosamente</span>\n\n';
                    log.innerHTML += `<span class="info">Respuesta:</span>\n${JSON.stringify(data, null, 2)}\n`;
                } else {
                    log.innerHTML += `<span class="error">✗ Error: ${data.message || 'Unknown error'}</span>\n`;
                }
            } catch (error) {
                log.innerHTML += `<span class="error">✗ Error de red: ${error.message}</span>\n`;
                log.innerHTML += `<span class="warning">Asegúrate de que el contenedor Node esté corriendo.</span>\n`;
            }
        }

        /**
         * Paso 3: Flujo completo automático
         */
        async function fullFlow() {
            const log = document.getElementById('log3');
            log.innerHTML = '<span class="info">=== INICIANDO FLUJO COMPLETO ===</span>\n\n';

            // Paso 1: Obtener JWT
            log.innerHTML += '<span class="info">[1/3] Obteniendo JWT desde PHP...</span>\n';

            try {
                const tokenResponse = await fetch('/api_puente_minodo.php?action=get_token', {
                    credentials: 'include',
                });
                const tokenData = await tokenResponse.json();

                if (!tokenData.success) {
                    log.innerHTML += `<span class="error">✗ No se pudo obtener JWT: ${tokenData.message}</span>\n`;
                    return;
                }

                jwtToken = tokenData.token;
                log.innerHTML += '<span class="success">✓ JWT obtenido</span>\n\n';

                // Paso 2: Verificar estado de enrollment
                log.innerHTML += '<span class="info">[2/3] Verificando estado de enrollment...</span>\n';

                const statusResponse = await fetch('/minodo-api/enrollment/status', {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const statusData = await statusResponse.json();

                if (statusData.success) {
                    log.innerHTML += '<span class="success">✓ Estado verificado</span>\n';
                    log.innerHTML += `   Enrolado: ${statusData.enrolled}\n\n`;
                } else {
                    log.innerHTML += `<span class="error">✗ Error al verificar: ${statusData.message}</span>\n\n`;
                }

                // Paso 3: Iniciar enrollment
                log.innerHTML += '<span class="info">[3/3] Iniciando enrollment...</span>\n';

                const enrollResponse = await fetch('/minodo-api/enrollment/start', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        displayName: 'Usuario de Prueba JWT'
                    }),
                });
                const enrollData = await enrollResponse.json();

                if (enrollData.success) {
                    log.innerHTML += '<span class="success">✓ Enrollment iniciado</span>\n';
                    log.innerHTML += `   Challenge: ${enrollData.challenge}\n\n`;
                } else {
                    log.innerHTML += `<span class="error">✗ Error al iniciar: ${enrollData.message}</span>\n\n`;
                }

                log.innerHTML += '<span class="success">=== FLUJO COMPLETADO ===</span>\n';

            } catch (error) {
                log.innerHTML += `<span class="error">✗ Error: ${error.message}</span>\n`;
            }
        }

        /**
         * Limpiar log
         */
        function clearLog(logId) {
            document.getElementById(logId).innerHTML = 'Log limpiado. Esperando acción...';
        }

        // Simulación de sesión al cargar (SOLO PARA TESTING)
        setupMockSession();
    </script>
</body>
</html>
