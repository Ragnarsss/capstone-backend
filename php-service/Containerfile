# Dockerfile para PHP 7.4.33 sobre Rocky Linux 9 con Apache

FROM rockylinux:9

# Instala Apache y PHP 7.4
RUN dnf install -y epel-release && \
    dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm && \
    dnf module reset php -y && \
    dnf module enable php:remi-7.4 -y && \
    dnf install -y \
        httpd \
        mod_ssl \
        php \
        php-fpm \
        php-pgsql \
        php-json \
        php-mbstring \
        postgresql \
    && dnf clean all

# Habilita mod_proxy_wstunnel para WebSocket proxying
RUN sed -i '/#LoadModule proxy_module/s/^#//' /etc/httpd/conf.modules.d/00-proxy.conf && \
    sed -i '/#LoadModule proxy_http_module/s/^#//' /etc/httpd/conf.modules.d/00-proxy.conf && \
    sed -i '/#LoadModule proxy_wstunnel_module/s/^#//' /etc/httpd/conf.modules.d/00-proxy.conf && \
    sed -i '/#LoadModule rewrite_module/s/^#//' /etc/httpd/conf.modules.d/00-base.conf

# Cambiar Apache MPM de event a prefork (requerido para mod_php)
# MPM prefork es necesario para que Apache pueda cargar el m√≥dulo PHP
RUN sed -i 's/^LoadModule mpm_event_module/#LoadModule mpm_event_module/' /etc/httpd/conf.modules.d/00-mpm.conf && \
    sed -i 's/^#LoadModule mpm_prefork_module/LoadModule mpm_prefork_module/' /etc/httpd/conf.modules.d/00-mpm.conf

# Generar certificado SSL autofirmado para testing
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/pki/tls/private/asistencia.key \
    -out /etc/pki/tls/certs/asistencia.crt \
    -subj "/C=CL/ST=Antofagasta/L=Antofagasta/O=UCN/CN=localhost"

# Deshabilitar configuracion SSL por defecto (usa certificados que no existen)
RUN mv /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/ssl.conf.disabled

# Copia la configuracion de Apache
COPY apache-config/00-proxy.conf /etc/httpd/conf.modules.d/
COPY apache-config/asistencia.conf /etc/httpd/conf.d/
COPY apache-config/asistencia-ssl.conf /etc/httpd/conf.d/

# Copia el codigo PHP
COPY src /var/www/html/

# Permisos (asegurar que todo sea legible por Apache)
RUN chown -R apache:apache /var/www/html && \
    chmod -R 755 /var/www/html && \
    find /var/www/html -type d -exec chmod 755 {} \; && \
    find /var/www/html -type f -exec chmod 644 {} \;

# Variables de entorno esperadas (configurar via compose)
# JWT_SECRET: Secreto para tokens de usuario
# JWT_SECRET_INTERNAL: Secreto para tokens de API interna
# NODE_MODULE_ENABLED: Habilitar modulo asistencia-node-integration
# NODE_SERVICE_URL: URL del servicio Node (http://node-service:3000)

EXPOSE 80 443

# Inicia Apache en foreground
CMD ["/usr/sbin/httpd", "-D", "FOREGROUND"]
